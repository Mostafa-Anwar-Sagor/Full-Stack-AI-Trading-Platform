{% extends 'base.html' %}
{% block title %}Backtest - AI Trading Platform{% endblock %}
{% block extra_css %}
<link rel="stylesheet" href="/static/css/dashboard.css">
<style>
    .backtest-setup {
        display: grid;
        grid-template-columns: 1fr 2fr;
        gap: 20px;
        margin-bottom: 24px;
    }

    .setup-form {
        background: var(--bg-card);
        border-radius: 20px;
        padding: 24px;
        border: 1px solid var(--border);
    }

    .form-title {
        font-size: 18px;
        font-weight: 700;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .form-title i {
        color: var(--accent);
    }

    .form-group {
        margin-bottom: 16px;
    }

    .form-group label {
        display: block;
        font-size: 13px;
        font-weight: 500;
        color: var(--text-secondary);
        margin-bottom: 6px;
    }

    .form-input {
        width: 100%;
        padding: 12px 14px;
        background: var(--bg-primary);
        border: 1px solid var(--border);
        border-radius: 10px;
        color: white;
        font-size: 14px;
    }

    .form-input:focus {
        outline: none;
        border-color: var(--accent);
    }

    .run-btn {
        width: 100%;
        padding: 16px;
        margin-top: 8px;
    }

    .results-preview {
        background: var(--bg-card);
        border-radius: 20px;
        padding: 24px;
        border: 1px solid var(--border);
    }

    .results-chart {
        height: 300px;
    }

    .results-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 16px;
        margin-bottom: 24px;
    }

    .result-item {
        background: var(--bg-card);
        border-radius: 14px;
        padding: 20px;
        border: 1px solid var(--border);
        text-align: center;
    }

    .ri-value {
        font-size: 24px;
        font-weight: 700;
    }

    .ri-label {
        font-size: 12px;
        color: var(--text-muted);
        margin-top: 4px;
        text-transform: uppercase;
    }

    .trades-log {
        max-height: 300px;
        overflow-y: auto;
    }
</style>
{% endblock %}

{% block content %}
<div class="bg-gradient"></div>
<button class="mobile-menu-toggle" id="mobile-menu-toggle"><i class="fas fa-bars"></i></button>
<aside class="sidebar" id="sidebar">
    <div class="logo">
        <div class="logo-icon">ðŸ“ˆ</div><span class="logo-text">AI Trading</span>
    </div>
    <nav class="nav-section">
        <div class="nav-section-title">Main</div>
        <a href="/" class="nav-item"><i class="fas fa-home"></i><span>Home</span></a>
        <a href="/dashboard/" class="nav-item"><i class="fas fa-chart-line"></i><span>Dashboard</span></a>
        <a href="/portfolio/" class="nav-item"><i class="fas fa-wallet"></i><span>Portfolio</span></a>
        <a href="/trading/" class="nav-item"><i class="fas fa-exchange-alt"></i><span>Trading</span></a>
        <a href="/market/" class="nav-item"><i class="fas fa-globe"></i><span>Market</span></a>
    </nav>
    <nav class="nav-section">
        <div class="nav-section-title">AI Features</div><a href="/agents/" class="nav-item"><i
                class="fas fa-robot"></i><span>AI Agents</span></a><a href="/predictions/" class="nav-item"><i
                class="fas fa-brain"></i><span>Predictions</span></a><a href="/backtest/" class="nav-item active"><i
                class="fas fa-history"></i><span>Backtest</span></a><a href="/risk/" class="nav-item"><i
                class="fas fa-shield-alt"></i><span>Risk</span></a>
    </nav>
    <nav class="nav-section" style="margin-top:auto"><a href="/settings/" class="nav-item"><i
                class="fas fa-cog"></i><span>Settings</span></a><a href="/logout/" class="nav-item"><i
                class="fas fa-sign-out-alt"></i><span>Logout</span></a></nav>
</aside>

<main class="main-content">
    <header class="header">
        <div class="header-left">
            <h1>Strategy Backtesting</h1>
            <p>Test your AI strategies on historical data</p>
        </div>
    </header>

    <div class="backtest-setup">
        <div class="setup-form">
            <div class="form-title"><i class="fas fa-cog"></i>Configuration</div>
            <div class="form-group"><label>Strategy</label><select class="form-input">
                    <option>PPO Agent</option>
                    <option>DQN Agent</option>
                    <option>LSTM Predictor</option>
                    <option>Moving Average Crossover</option>
                </select></div>
            <div class="form-group"><label>Asset</label><select class="form-input">
                    <option>BTC/USD</option>
                    <option>ETH/USD</option>
                    <option>SOL/USD</option>
                </select></div>
            <div class="form-group"><label>Start Date</label><input type="date" class="form-input" value="2025-01-01">
            </div>
            <div class="form-group"><label>End Date</label><input type="date" class="form-input" value="2026-02-01">
            </div>
            <div class="form-group"><label>Initial Capital ($)</label><input type="number" class="form-input"
                    value="10000"></div>
            <div class="form-group"><label>Position Size (%)</label><input type="number" class="form-input" value="10">
            </div>
            <button class="btn btn-primary run-btn" onclick="runBacktest()"><i class="fas fa-play"></i>Run
                Backtest</button>
        </div>
        <div class="results-preview">
            <div class="form-title"><i class="fas fa-chart-line"></i>Equity Curve</div>
            <div class="results-chart"><canvas id="equityChart"></canvas></div>
        </div>
    </div>

    <div class="results-grid">
        <div class="result-item">
            <div class="ri-value" style="color:var(--success)">+32.5%</div>
            <div class="ri-label">Total Return</div>
        </div>
        <div class="result-item">
            <div class="ri-value">1.85</div>
            <div class="ri-label">Sharpe Ratio</div>
        </div>
        <div class="result-item">
            <div class="ri-value" style="color:var(--danger)">-12.3%</div>
            <div class="ri-label">Max Drawdown</div>
        </div>
        <div class="result-item">
            <div class="ri-value">67.5%</div>
            <div class="ri-label">Win Rate</div>
        </div>
        <div class="result-item">
            <div class="ri-value">156</div>
            <div class="ri-label">Total Trades</div>
        </div>
        <div class="result-item">
            <div class="ri-value">1.65</div>
            <div class="ri-label">Profit Factor</div>
        </div>
        <div class="result-item">
            <div class="ri-value">$285</div>
            <div class="ri-label">Avg Win</div>
        </div>
        <div class="result-item">
            <div class="ri-value">-$142</div>
            <div class="ri-label">Avg Loss</div>
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            <h2 class="card-title">Trade Log</h2>
        </div>
        <div class="table-responsive trades-log">
            <table class="trades-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Type</th>
                        <th>Price</th>
                        <th>Size</th>
                        <th>P&L</th>
                    </tr>
                </thead>
                <tbody id="trade-log">
                    <tr>
                        <td>2026-01-15</td>
                        <td><span class="trade-type buy">BUY</span></td>
                        <td>$42,150</td>
                        <td>0.05 BTC</td>
                        <td style="color:var(--success)">+$325</td>
                    </tr>
                    <tr>
                        <td>2026-01-20</td>
                        <td><span class="trade-type sell">SELL</span></td>
                        <td>$43,850</td>
                        <td>0.05 BTC</td>
                        <td style="color:var(--success)">+$85</td>
                    </tr>
                    <tr>
                        <td>2026-01-25</td>
                        <td><span class="trade-type buy">BUY</span></td>
                        <td>$43,200</td>
                        <td>0.08 BTC</td>
                        <td style="color:var(--danger)">-$156</td>
                    </tr>
                    <tr>
                        <td>2026-01-30</td>
                        <td><span class="trade-type sell">SELL</span></td>
                        <td>$42,600</td>
                        <td>0.08 BTC</td>
                        <td style="color:var(--success)">+$412</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</main>

<div class="toast-container" id="toast-container"></div>
<script>
    document.getElementById('mobile-menu-toggle')?.addEventListener('click', () => document.getElementById('sidebar').classList.toggle('active'));
    const ctx = document.getElementById('equityChart')?.getContext('2d');
    if (ctx) {
        const data = []; let v = 10000;
        for (let i = 0; i < 52; i++) { v *= 1 + (Math.random() - 0.45) * 0.04; data.push(v); }
        const gradient = ctx.createLinearGradient(0, 0, 0, 300);
        gradient.addColorStop(0, 'rgba(16, 185, 129, 0.3)'); gradient.addColorStop(1, 'rgba(16, 185, 129, 0.0)');
        new Chart(ctx, { type: 'line', data: { labels: Array.from({ length: 52 }, (_, i) => `W${i + 1}`), datasets: [{ data, fill: true, backgroundColor: gradient, borderColor: '#10b981', borderWidth: 2, tension: 0.3, pointRadius: 0 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { grid: { display: false }, ticks: { color: '#6b7280', maxTicksLimit: 8 } }, y: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#6b7280', callback: v => `$${(v / 1000).toFixed(1)}k` } } } } });
    }
    function runBacktest() { const t = document.createElement('div'); t.className = 'toast success'; t.innerHTML = '<i class="fas fa-check-circle"></i>Backtest completed successfully!'; document.getElementById('toast-container').appendChild(t); setTimeout(() => t.remove(), 3000); }
</script>
{% endblock %}