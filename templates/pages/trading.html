{% extends 'base.html' %}
{% block title %}Trading Terminal - AI Trading Platform{% endblock %}
{% block extra_css %}
<link rel="stylesheet" href="/static/css/dashboard.css">
<script src="https://unpkg.com/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>
<style>
    :root {
        --chart-bg: #0b0e11;
        --chart-grid: rgba(255, 255, 255, 0.04);
    }

    .trading-layout {
        display: grid;
        grid-template-columns: 260px 1fr 320px;
        gap: 0;
        height: calc(100vh - 80px);
        background: var(--chart-bg);
    }

    .trading-sidebar {
        background: #1e2329;
        display: flex;
        flex-direction: column;
        border-right: 1px solid #2b3139;
        overflow: hidden;
    }

    .order-book {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    .order-book-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 14px;
        border-bottom: 1px solid #2b3139;
    }

    .ob-title {
        font-weight: 600;
        font-size: 14px;
    }

    .ob-pair {
        color: #848e9c;
        font-size: 12px;
    }

    .order-book-columns {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        padding: 8px 14px;
        font-size: 11px;
        color: #848e9c;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        border-bottom: 1px solid #2b3139;
    }

    .order-book-sells,
    .order-book-buys {
        flex: 1;
        overflow-y: auto;
    }

    .order-row {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        padding: 3px 14px;
        font-size: 12px;
        font-family: 'Roboto Mono', monospace;
        cursor: pointer;
        position: relative;
    }

    .order-row::before {
        content: '';
        position: absolute;
        right: 0;
        top: 0;
        bottom: 0;
        background: var(--row-bg);
        opacity: 0.15;
    }

    .order-row.sell {
        --row-bg: #f6465d;
    }

    .order-row.buy {
        --row-bg: #0ecb81;
    }

    .order-row:hover {
        background: rgba(255, 255, 255, 0.04);
    }

    .order-row.sell .price {
        color: #f6465d;
    }

    .order-row.buy .price {
        color: #0ecb81;
    }

    .order-row .amount,
    .order-row .total {
        text-align: right;
        color: #eaecef;
    }

    .price-spread {
        padding: 14px;
        background: #0b0e11;
        text-align: center;
        border-top: 1px solid #2b3139;
        border-bottom: 1px solid #2b3139;
    }

    .spread-price {
        font-size: 22px;
        font-weight: 700;
        font-family: 'Roboto Mono', monospace;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
    }

    .spread-price.up {
        color: #0ecb81;
    }

    .spread-price.down {
        color: #f6465d;
    }

    .spread-arrow {
        font-size: 16px;
    }

    .spread-usd {
        font-size: 13px;
        color: #848e9c;
        margin-top: 4px;
    }

    .chart-section {
        display: flex;
        flex-direction: column;
        background: var(--chart-bg);
        min-width: 0;
    }

    .chart-header {
        display: flex;
        align-items: center;
        gap: 24px;
        padding: 10px 16px;
        background: #1e2329;
        border-bottom: 1px solid #2b3139;
    }

    .pair-info {
        display: flex;
        align-items: center;
        gap: 16px;
    }

    .pair-dropdown {
        padding: 8px 12px;
        background: transparent;
        border: none;
        color: #eaecef;
        font-size: 18px;
        font-weight: 700;
        cursor: pointer;
    }

    .pair-dropdown option {
        background: #1e2329;
    }

    .current-price {
        font-size: 22px;
        font-weight: 700;
        font-family: 'Roboto Mono', monospace;
    }

    .current-price.up {
        color: #0ecb81;
    }

    .current-price.down {
        color: #f6465d;
    }

    .price-change {
        font-size: 13px;
        padding: 2px 6px;
        border-radius: 4px;
        font-weight: 500;
    }

    .price-change.positive {
        color: #0ecb81;
    }

    .price-change.negative {
        color: #f6465d;
    }

    .chart-stats {
        display: flex;
        gap: 20px;
        margin-left: auto;
    }

    .chart-stat {
        display: flex;
        flex-direction: column;
    }

    .chart-stat-label {
        font-size: 11px;
        color: #848e9c;
    }

    .chart-stat-value {
        font-size: 13px;
        color: #eaecef;
        font-family: 'Roboto Mono', monospace;
    }

    .chart-controls {
        display: flex;
        gap: 8px;
        padding: 8px 16px;
        background: #1e2329;
        border-bottom: 1px solid #2b3139;
        align-items: center;
    }

    .timeframe-btns {
        display: flex;
        gap: 2px;
    }

    .tf-btn {
        padding: 6px 10px;
        background: transparent;
        border: none;
        color: #848e9c;
        font-size: 12px;
        font-weight: 500;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.15s;
    }

    .tf-btn:hover {
        color: #eaecef;
    }

    .tf-btn.active {
        background: #2b3139;
        color: #f0b90b;
    }

    .chart-type-btns {
        display: flex;
        gap: 4px;
        margin-left: 16px;
    }

    .chart-type-btn {
        padding: 6px 10px;
        background: transparent;
        border: 1px solid #2b3139;
        border-radius: 4px;
        color: #848e9c;
        font-size: 12px;
        cursor: pointer;
    }

    .chart-type-btn.active {
        border-color: #f0b90b;
        color: #f0b90b;
    }

    .indicator-btns {
        display: flex;
        gap: 8px;
        margin-left: auto;
    }

    .indicator-btn {
        padding: 4px 10px;
        background: #2b3139;
        border: none;
        border-radius: 4px;
        color: #848e9c;
        font-size: 11px;
        cursor: pointer;
    }

    .indicator-btn.active {
        color: #f0b90b;
    }

    .chart-container {
        flex: 1;
        position: relative;
        min-height: 400px;
    }

    #trading-chart {
        width: 100%;
        height: 100%;
    }

    .chart-overlay {
        position: absolute;
        top: 10px;
        left: 10px;
        display: flex;
        gap: 16px;
        font-size: 11px;
        z-index: 10;
    }

    .chart-overlay-item {
        display: flex;
        align-items: center;
        gap: 4px;
    }

    .ma-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
    }

    .trading-panel {
        background: #1e2329;
        display: flex;
        flex-direction: column;
        border-left: 1px solid #2b3139;
        overflow-y: auto;
    }

    .panel-tabs {
        display: flex;
        border-bottom: 1px solid #2b3139;
    }

    .panel-tab {
        flex: 1;
        padding: 14px;
        text-align: center;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.15s;
        border-bottom: 2px solid transparent;
    }

    .panel-tab.buy {
        color: #848e9c;
    }

    .panel-tab.sell {
        color: #848e9c;
    }

    .panel-tab.buy.active {
        color: #0ecb81;
        border-color: #0ecb81;
        background: rgba(14, 203, 129, 0.08);
    }

    .panel-tab.sell.active {
        color: #f6465d;
        border-color: #f6465d;
        background: rgba(246, 70, 93, 0.08);
    }

    .order-form {
        padding: 16px;
    }

    .order-types {
        display: flex;
        gap: 0;
        margin-bottom: 16px;
        background: #2b3139;
        border-radius: 4px;
        padding: 2px;
    }

    .order-type-btn {
        flex: 1;
        padding: 8px;
        background: transparent;
        border: none;
        border-radius: 3px;
        color: #848e9c;
        font-size: 12px;
        font-weight: 500;
        cursor: pointer;
    }

    .order-type-btn.active {
        background: #0b0e11;
        color: #eaecef;
    }

    .input-group {
        margin-bottom: 12px;
    }

    .input-wrapper {
        display: flex;
        align-items: center;
        background: #2b3139;
        border: 1px solid #2b3139;
        border-radius: 4px;
        transition: border-color 0.15s;
    }

    .input-wrapper:focus-within {
        border-color: #f0b90b;
    }

    .input-label-side {
        padding: 0 12px;
        color: #848e9c;
        font-size: 12px;
        min-width: 60px;
    }

    .input-field {
        flex: 1;
        padding: 12px 0;
        background: transparent;
        border: none;
        color: #eaecef;
        font-size: 14px;
        font-family: 'Roboto Mono', monospace;
        text-align: right;
    }

    .input-field:focus {
        outline: none;
    }

    .input-suffix {
        padding: 0 12px;
        color: #848e9c;
        font-size: 12px;
    }

    .percent-btns {
        display: flex;
        gap: 8px;
        margin-bottom: 16px;
    }

    .percent-btn {
        flex: 1;
        padding: 6px;
        background: #2b3139;
        border: none;
        border-radius: 4px;
        color: #848e9c;
        font-size: 11px;
        font-weight: 500;
        cursor: pointer;
    }

    .percent-btn:hover {
        color: #eaecef;
    }

    .order-summary {
        background: #0b0e11;
        border-radius: 4px;
        padding: 12px;
        margin-bottom: 16px;
    }

    .summary-row {
        display: flex;
        justify-content: space-between;
        padding: 4px 0;
        font-size: 12px;
    }

    .summary-row .label {
        color: #848e9c;
    }

    .summary-row .value {
        color: #eaecef;
        font-family: 'Roboto Mono', monospace;
    }

    .order-btn {
        width: 100%;
        padding: 14px;
        font-size: 14px;
        font-weight: 600;
        border-radius: 4px;
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        transition: all 0.15s;
    }

    .order-btn.buy {
        background: #0ecb81;
        color: #fff;
    }

    .order-btn.sell {
        background: #f6465d;
        color: #fff;
    }

    .order-btn:hover {
        opacity: 0.9;
    }

    .ai-panel {
        padding: 16px;
        border-top: 1px solid #2b3139;
    }

    .ai-panel-header {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 12px;
        font-size: 13px;
        font-weight: 600;
        color: #eaecef;
    }

    .ai-panel-header i {
        color: #f0b90b;
    }

    .ai-signal-box {
        background: #0b0e11;
        border-radius: 4px;
        padding: 12px;
    }

    .ai-signal-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
    }

    .signal-label {
        color: #848e9c;
        font-size: 12px;
    }

    .signal-badge {
        padding: 4px 12px;
        border-radius: 4px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
    }

    .signal-badge.buy,
    .signal-badge.strong-buy {
        background: rgba(14, 203, 129, 0.15);
        color: #0ecb81;
    }

    .signal-badge.sell,
    .signal-badge.strong-sell {
        background: rgba(246, 70, 93, 0.15);
        color: #f6465d;
    }

    .signal-badge.hold {
        background: rgba(132, 142, 156, 0.15);
        color: #848e9c;
    }

    .confidence-bar {
        height: 4px;
        background: #2b3139;
        border-radius: 2px;
        overflow: hidden;
        margin-top: 8px;
    }

    .confidence-fill {
        height: 100%;
        border-radius: 2px;
    }

    .ai-indicators {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
        margin-top: 12px;
    }

    .ai-indicator {
        background: #0b0e11;
        border-radius: 4px;
        padding: 10px;
        text-align: center;
    }

    .ai-indicator-value {
        font-size: 14px;
        font-weight: 600;
        font-family: 'Roboto Mono', monospace;
    }

    .ai-indicator-label {
        font-size: 10px;
        color: #848e9c;
        margin-top: 2px;
    }

    .ticker-bar {
        display: flex;
        gap: 0;
        padding: 0 16px;
        background: #0b0e11;
        border-top: 1px solid #2b3139;
        overflow-x: auto;
        position: fixed;
        bottom: 0;
        left: 280px;
        right: 0;
        z-index: 100;
    }

    .ticker-item {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 16px;
        border-right: 1px solid #2b3139;
        white-space: nowrap;
        cursor: pointer;
    }

    .ticker-item:hover {
        background: #1e2329;
    }

    .ticker-symbol {
        font-weight: 600;
        font-size: 12px;
        color: #eaecef;
    }

    .ticker-price {
        font-size: 12px;
        font-family: 'Roboto Mono', monospace;
    }

    .ticker-change {
        font-size: 11px;
        font-weight: 500;
    }

    .ticker-change.positive {
        color: #0ecb81;
    }

    .ticker-change.negative {
        color: #f6465d;
    }

    .loading-overlay {
        position: absolute;
        inset: 0;
        background: rgba(11, 14, 17, 0.9);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 50;
    }

    .loading-spinner {
        width: 40px;
        height: 40px;
        border: 3px solid #2b3139;
        border-top-color: #f0b90b;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        to {
            transform: rotate(360deg);
        }
    }

    @media (max-width: 1200px) {
        .trading-layout {
            grid-template-columns: 1fr 320px;
        }

        .trading-sidebar {
            display: none;
        }

        .ticker-bar {
            left: 0;
        }
    }

    @media (max-width: 900px) {
        .trading-layout {
            grid-template-columns: 1fr;
        }

        .trading-panel {
            display: none;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="bg-gradient"></div>
<button class="mobile-menu-toggle" id="mobile-menu-toggle"><i class="fas fa-bars"></i></button>
<aside class="sidebar" id="sidebar">
    <div class="logo">
        <div class="logo-icon">ðŸ“ˆ</div><span class="logo-text">AI Trading</span>
    </div>
    <nav class="nav-section">
        <div class="nav-section-title">Main</div>
        <a href="/" class="nav-item"><i class="fas fa-home"></i><span>Home</span></a>
        <a href="/dashboard/" class="nav-item"><i class="fas fa-chart-line"></i><span>Dashboard</span></a>
        <a href="/portfolio/" class="nav-item"><i class="fas fa-wallet"></i><span>Portfolio</span></a>
        <a href="/trading/" class="nav-item active"><i class="fas fa-exchange-alt"></i><span>Trading</span></a>
        <a href="/market/" class="nav-item"><i class="fas fa-globe"></i><span>Market</span></a>
    </nav>
    <nav class="nav-section">
        <div class="nav-section-title">AI Features</div>
        <a href="/agents/" class="nav-item"><i class="fas fa-robot"></i><span>AI Agents</span></a>
        <a href="/predictions/" class="nav-item"><i class="fas fa-brain"></i><span>Predictions</span></a>
        <a href="/backtest/" class="nav-item"><i class="fas fa-history"></i><span>Backtest</span></a>
        <a href="/risk/" class="nav-item"><i class="fas fa-shield-alt"></i><span>Risk</span></a>
    </nav>
    <nav class="nav-section" style="margin-top:auto">
        <a href="/settings/" class="nav-item"><i class="fas fa-cog"></i><span>Settings</span></a>
        <a href="/logout/" class="nav-item"><i class="fas fa-sign-out-alt"></i><span>Logout</span></a>
    </nav>
</aside>

<main class="main-content" style="padding:0;margin-left:280px">
    <div class="trading-layout">
        <!-- Order Book -->
        <div class="trading-sidebar">
            <div class="order-book">
                <div class="order-book-header">
                    <span class="ob-title">Order Book</span>
                    <span class="ob-pair" id="ob-pair">BTC/USDT</span>
                </div>
                <div class="order-book-columns"><span>Price(USDT)</span><span
                        style="text-align:right">Amount(BTC)</span><span style="text-align:right">Total</span></div>
                <div class="order-book-sells" id="order-book-sells"></div>
                <div class="price-spread">
                    <div class="spread-price up" id="spread-price"><span id="spread-arrow">â†‘</span> $68,548.04</div>
                    <div class="spread-usd" id="spread-change">+2.29% (24h)</div>
                </div>
                <div class="order-book-buys" id="order-book-buys"></div>
            </div>
        </div>

        <!-- Chart Section -->
        <div class="chart-section">
            <div class="chart-header">
                <div class="pair-info">
                    <select class="pair-dropdown" id="trading-pair">
                        <option value="BTCUSDT">BTC/USDT</option>
                        <option value="ETHUSDT">ETH/USDT</option>
                        <option value="SOLUSDT">SOL/USDT</option>
                        <option value="BNBUSDT">BNB/USDT</option>
                        <option value="XRPUSDT">XRP/USDT</option>
                        <option value="DOGEUSDT">DOGE/USDT</option>
                    </select>
                    <div class="current-price up" id="header-price">$68,548.04</div>
                    <span class="price-change positive" id="header-change">+2.29%</span>
                </div>
                <div class="chart-stats">
                    <div class="chart-stat"><span class="chart-stat-label">24h High</span><span class="chart-stat-value"
                            id="stat-high">$71,751.33</span></div>
                    <div class="chart-stat"><span class="chart-stat-label">24h Low</span><span class="chart-stat-value"
                            id="stat-low">$67,300.00</span></div>
                    <div class="chart-stat"><span class="chart-stat-label">24h Vol(BTC)</span><span
                            class="chart-stat-value" id="stat-volume">63,158.22</span></div>
                    <div class="chart-stat"><span class="chart-stat-label">24h Vol(USDT)</span><span
                            class="chart-stat-value" id="stat-turnover">4.38B</span></div>
                </div>
            </div>
            <div class="chart-controls">
                <div class="timeframe-btns">
                    <button class="tf-btn" data-tf="1m">1m</button>
                    <button class="tf-btn" data-tf="5m">5m</button>
                    <button class="tf-btn" data-tf="15m">15m</button>
                    <button class="tf-btn" data-tf="1h">1H</button>
                    <button class="tf-btn active" data-tf="4h">4H</button>
                    <button class="tf-btn" data-tf="1d">1D</button>
                    <button class="tf-btn" data-tf="1w">1W</button>
                </div>
                <div class="chart-type-btns">
                    <button class="chart-type-btn active" title="Candlestick"><i class="fas fa-chart-bar"></i></button>
                    <button class="chart-type-btn" title="Line"><i class="fas fa-chart-line"></i></button>
                </div>
                <div class="indicator-btns">
                    <button class="indicator-btn active" id="btn-ma">MA</button>
                    <button class="indicator-btn" id="btn-ema">EMA</button>
                    <button class="indicator-btn" id="btn-boll">BOLL</button>
                    <button class="indicator-btn active" id="btn-vol">Vol</button>
                </div>
            </div>
            <div class="chart-container">
                <div class="loading-overlay" id="chart-loading">
                    <div class="loading-spinner"></div>
                </div>
                <div class="chart-overlay" id="chart-overlay">
                    <div class="chart-overlay-item"><span class="ma-dot" style="background:#f0b90b"></span>MA(7): <span
                            id="ma7-value">--</span></div>
                    <div class="chart-overlay-item"><span class="ma-dot" style="background:#e84142"></span>MA(25): <span
                            id="ma25-value">--</span></div>
                    <div class="chart-overlay-item"><span class="ma-dot" style="background:#9945ff"></span>MA(99): <span
                            id="ma99-value">--</span></div>
                </div>
                <div id="trading-chart"></div>
            </div>
        </div>

        <!-- Trading Panel -->
        <div class="trading-panel">
            <div class="panel-tabs">
                <div class="panel-tab buy active" onclick="setOrderSide('buy')">BUY</div>
                <div class="panel-tab sell" onclick="setOrderSide('sell')">SELL</div>
            </div>
            <div class="order-form">
                <div class="order-types">
                    <button class="order-type-btn active" data-type="limit">Limit</button>
                    <button class="order-type-btn" data-type="market">Market</button>
                    <button class="order-type-btn" data-type="stop">Stop-Limit</button>
                </div>
                <div class="input-group">
                    <div class="input-wrapper">
                        <span class="input-label-side">Price</span>
                        <input type="text" class="input-field" id="order-price" value="68,548.04">
                        <span class="input-suffix">USDT</span>
                    </div>
                </div>
                <div class="input-group">
                    <div class="input-wrapper">
                        <span class="input-label-side">Amount</span>
                        <input type="text" class="input-field" id="order-amount" placeholder="0.00000">
                        <span class="input-suffix" id="order-asset">BTC</span>
                    </div>
                </div>
                <div class="percent-btns">
                    <button class="percent-btn" data-pct="25">25%</button>
                    <button class="percent-btn" data-pct="50">50%</button>
                    <button class="percent-btn" data-pct="75">75%</button>
                    <button class="percent-btn" data-pct="100">100%</button>
                </div>
                <div class="input-group">
                    <div class="input-wrapper">
                        <span class="input-label-side">Total</span>
                        <input type="text" class="input-field" id="order-total" placeholder="0.00" readonly>
                        <span class="input-suffix">USDT</span>
                    </div>
                </div>
                <div class="order-summary">
                    <div class="summary-row"><span class="label">Available</span><span class="value"
                            id="available-balance">10,000.00 USDT</span></div>
                    <div class="summary-row"><span class="label">Fee (0.1%)</span><span class="value"
                            id="order-fee">0.00 USDT</span></div>
                    <div class="summary-row"><span class="label">Est. Received</span><span class="value"
                            id="est-received">0.00000 BTC</span></div>
                </div>
                <button class="order-btn buy" id="submit-order" onclick="submitOrder()"><i class="fas fa-check"></i> Buy
                    BTC</button>
            </div>

            <div class="ai-panel">
                <div class="ai-panel-header"><i class="fas fa-brain"></i> AI Analysis</div>
                <div class="ai-signal-box">
                    <div class="ai-signal-row"><span class="signal-label">Signal</span><span class="signal-badge sell"
                            id="ai-signal">SELL</span></div>
                    <div class="confidence-bar">
                        <div class="confidence-fill" id="confidence-fill" style="width:78%;background:#f6465d"></div>
                    </div>
                    <div style="display:flex;justify-content:space-between;margin-top:4px;font-size:11px;color:#848e9c">
                        <span>Confidence</span><span id="ai-confidence">78%</span></div>
                </div>
                <div class="ai-indicators">
                    <div class="ai-indicator">
                        <div class="ai-indicator-value" id="ai-rsi" style="color:#0ecb81">65.2</div>
                        <div class="ai-indicator-label">RSI (14)</div>
                    </div>
                    <div class="ai-indicator">
                        <div class="ai-indicator-value" id="ai-macd" style="color:#f6465d">+186</div>
                        <div class="ai-indicator-label">MACD</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Ticker Bar -->
    <div class="ticker-bar" id="ticker-bar"></div>
</main>

<div class="toast-container" id="toast-container"></div>
<script src="/static/js/trading-binance.js"></script>
{% endblock %}